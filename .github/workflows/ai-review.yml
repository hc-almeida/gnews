name: AI Code Review (ChatGPT)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Review PR diff with ChatGPT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          COMMENTS_URL: ${{ github.event.pull_request.comments_url }}
        shell: bash
        run: |
          set -euo pipefail

          # 1) Buscar o diff do PR
          DIFF="$(curl -fsSL \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3.diff" \
            "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}")"

          # 2) Limitar tamanho (evita estourar tokens)
          DIFF_TRIMMED="$(printf "%s" "$DIFF" | head -c 40000)"

          # 3) Prompt
          PROMPT=$'Você é um Engenheiro de Segurança Sênior (DevSecOps).\n\nAnalise APENAS o DIFF do Pull Request e identifique:\n- Vulnerabilidades OWASP Top 10 (priorize SQL Injection e Insecure Deserialization)\n- Problemas de segurança em queries e inputs\n- Code smells relevantes\n- Sugestões claras de correção\n\nFormato:\n1) Achados críticos\n2) Achados importantes\n3) Sugestões\n\nDIFF:\n'

          REQUEST_JSON="$(jq -n \
            --arg system "Você é um revisor de código focado em segurança." \
            --arg user "$PROMPT$DIFF_TRIMMED" \
            '{
              model: "gpt-4o-mini",
              messages: [
                { role: "system", content: $system },
                { role: "user", content: $user }
              ],
              temperature: 0.2,
              max_tokens: 1200
            }')"

          RESPONSE="$(curl -fsSL \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AI_API_KEY}" \
            -d "$REQUEST_JSON" \
            https://api.openai.com/v1/chat/completions)"

          REVIEW_TEXT="$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')"

          if [ -z "$REVIEW_TEXT" ]; then
            REVIEW_TEXT="Falha ao gerar review.\n\nResposta bruta:\n\`\`\`json\n$(echo "$RESPONSE" | jq -c '.')\n\`\`\`"
          fi

          BODY=$'## AI Code Review (ChatGPT)\n\n'"$REVIEW_TEXT"$'\n\n---\n_Gerado automaticamente via GitHub Actions_'

          curl -fsSL \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "$BODY" '{body: $body}')" \
            "$COMMENTS_URL"
